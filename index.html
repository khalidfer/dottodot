<!DOCTYPE html>
<!-- MODIFIED: Removed 'dark' class, JS will add it -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dot-to-Dot Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NEW: Google API for YouTube button -->
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <style>
        /* Custom styles for a better look */
        .d2d-body {
            font-family: 'Inter', sans-serif;
        }
        .d2d-canvas {
            background-color: #ffffff;
            /* Ensure canvas doesn't shrink smaller than its set size */
            min-width: var(--canvas-width, auto);
            min-height: var(--canvas-height, auto);
        }
        .tool-radio:checked + label {
            background-color: #3b82f6; /* bg-blue-600 */
            color: #ffffff; /* text-white */
            border-color: #3b82f6; /* border-blue-600 */
        }
        .tool-radio:disabled + label {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Cursors */
        .eraser-cursor { cursor: none; }
        .pan-cursor { cursor: grab; }
        .panning-cursor { cursor: grabbing; }
        .eyedropper-cursor { cursor: crosshair; } /* Can be more specific later */
        
        #canvas-container {
            max-width: 100%;
            max-height: 85vh;
        }
        /* Styles for Dark Mode Toggle */
        .dot {
            transition: transform 0.2s ease-in-out;
        }
        input:checked ~ .dot {
            transform: translateX(1.75rem); /* 28px */
        }
        input:checked ~ .block {
            background-color: #3b82f6; /* blue-600 */
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Configuration for Tailwind dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<!-- MODIFIED: Restored dark mode classes -->
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col items-center d2d-body">

    <!-- NEW: Navigation Bar -->
    <nav class="w-full bg-white dark:bg-gray-800 shadow-md">
        <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center space-x-4">
                    <!-- NEW: Blog Link -->
                    <a href="https://khalidfer.com" target="_blank" rel="noopener noreferrer" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 text-sm font-medium">Blog</a>
                    <!-- NEW: Share Button -->
                    <button id="shareButton" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 text-sm font-medium">Share</button>
                    <button id="aboutButton" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 text-sm font-medium">About</button>
                    <button id="contactButton" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 text-sm font-medium">Contact</button>
                </div>
                
                <!-- Dark Mode Toggle -->
                <label for="darkModeToggle" class="flex items-center cursor-pointer">
                    <!-- Sun icon -->
                    <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a5 5 0 100-10 5 5 0 000 10z"></path></svg>
                    <div class="relative mx-2">
                        <input type="checkbox" id="darkModeToggle" class="sr-only">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full block"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full dot"></div>
                    </div>
                    <!-- Moon icon -->
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </label>
            </div>
        </div>
    </nav>

    <!-- Main Content Wrapper -->
    <!-- MODIFIED: Added max-w-7xl and padding for "compact" layout -->
    <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- MODIFIED: Switched to CSS Grid, changed lg: to md: -->
        <main class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">

            
            <!-- MODIFIED: Restored dark mode classes -->
            <aside class="w-full md:col-span-1 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-300 dark:border-gray-600 pb-2">Controls</h2>
                
                
                <div class="mb-4">
                    <label for="imageLoader" class="block text-sm font-medium mb-2">1. Upload Image(s)</label>
                    <input type="file" id="imageLoader" accept="image/*" multiple class="block w-full text-sm text-gray-500 dark:text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 dark:file:bg-blue-900
                        file:text-blue-700 dark:file:text-blue-300
                        hover:file:bg-blue-100 dark:hover:file:bg-blue-800
                        cursor-pointer">
                </div>

                
                <div class="mb-4">
                    <label for="imageSelector" class="block text-sm font-medium mb-2">2. Select Active Image</label>
                    <select id="imageSelector" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5" disabled>
                        <option value="">Upload images first</option>
                    </select>
                </div>

                
                <div class="mb-4">
                    <span class="block text-sm font-medium mb-2">3. Select Tool</span>
                    <!-- MODIFIED: Grid cols 3 for new tool -->
                    <div class="grid grid-cols-3 gap-2">
                        
                        <div>
                            <input type="radio" name="tool" id="tool-add" value="add" class="sr-only tool-radio" checked disabled>
                            <label for="tool-add" class="flex flex-col items-center justify-center p-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer text-center text-sm font-medium transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Add Dots
                            </label>
                        </div>
                        
                        <div>
                            <input type="radio" name="tool" id="tool-erase-image" value="erase-image" class="sr-only tool-radio" disabled>
                            <label for="tool-erase-image" class="flex flex-col items-center justify-center p-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer text-center text-sm font-medium transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Erase Image
                            </label>
                        </div>
                         
                        <div>
                            <input type="radio" name="tool" id="tool-erase-dots" value="erase-dots" class="sr-only tool-radio" disabled>
                            <label for="tool-erase-dots" class="flex flex-col items-center justify-center p-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer text-center text-sm font-medium transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2A9 9 0 111 12a9 9 0 0118 0z" />
                                </svg>
                                Erase Dots
                            </label>
                        </div>
                        
                        <div>
                            <input type="radio" name="tool" id="tool-pan" value="pan" class="sr-only tool-radio" disabled>
                            <label for="tool-pan" class="flex flex-col items-center justify-center p-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer text-center text-sm font-medium transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 11.5l5 5 5-5m-10-2l5-5 5 5" />
                                </svg>
                                Pan
                            </label>
                        </div>

                        <!-- NEW Eyedropper Tool Button -->
                        <div>
                            <input type="radio" name="tool" id="tool-eyedropper" value="eyedropper" class="sr-only tool-radio" disabled>
                            <label for="tool-eyedropper" class="flex flex-col items-center justify-center p-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer text-center text-sm font-medium transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 17.5c-.266 0-.52-.105-.707-.293l-4.243-4.243a1 1 0 010-1.414l7.07-7.071a1 1 0 011.414 0l4.243 4.243a1 1 0 010 1.414l-7.071 7.07a1 1 0 01-.707.293zM10.5 6.5l-5 5L9 15l5-5-3.5-3.5zM15 12l-1.5 1.5 5 5L22 15l-5-5-2 2z" />
                                </svg>
                                Pick Color
                            </label>
                        </div>
                    </div>
                </div>

                
                <div class="mb-4 space-y-3">
                    <div>
                        <label for="dotSize" class="block text-sm font-medium">Dot Size (px)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="dotSize" min="1" max="20" value="3" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <span id="dotSizeValue" class="text-sm font-mono w-6 text-right">3</span>
                        </div>
                    </div>
                    
                    <div>
                        <label for="lineWidth" class="block text-sm font-medium">Line Width (px)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="lineWidth" min="0" max="10" value="1" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <span id="lineWidthValue" class="text-sm font-mono w-6 text-right">1</span>
                        </div>
                    </div>
                    
                    <div>
                        <label for="fontSize" class="block text-sm font-medium">Number Size (px)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="fontSize" min="8" max="32" value="12" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <span id="fontSizeValue" class="text-sm font-mono w-6 text-right">12</span>
                        </div>
                    </div>
                    <div>
                        <label for="eraseDotsRadius" class="block text-sm font-medium">Erase Dots Radius (px)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="eraseDotsRadius" min="5" max="50" value="20" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <span id="eraseDotsRadiusValue" class="text-sm font-mono w-6 text-right">20</span>
                        </div>
                    </div>
                    <div>
                        <label for="eraseImageRadius" class="block text-sm font-medium">Erase Image Radius (px)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="eraseImageRadius" min="5" max="50" value="20" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <span id="eraseImageRadiusValue" class="text-sm font-mono w-6 text-right">20</span>
                        </div>
                    </div>
                    <div>
                        <label for="spacingSlider" class="block text-sm font-medium">Fixed Spacing (px)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="spacingSlider" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <span id="spacingValue" class="text-sm font-mono w-6 text-right">0</span>
                        </div>
                    </div>

                    
                    <div class="grid grid-cols-2 gap-2 pt-2">
                        <div>
                            <label for="dotColorPicker" class="block text-sm font-medium mb-1">Dot Color</label>
                            <input type="color" id="dotColorPicker" value="#000000" class="w-full h-8 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer">
                        </div>
                        <div>
                            <label for="lineColorPicker" class="block text-sm font-medium mb-1">Line Color</label>
                            <input type="color" id="lineColorPicker" value="#000000" class="w-full h-8 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer">
                        </div>
                    </div>
                </div>

                
                <div class="mb-4 space-y-2">
                    <label class="block text-sm font-medium">Zoom</label>
                    <div class="flex items-center gap-2">
                        <button id="zoomOutButton" class="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-bold text-lg disabled:opacity-50" disabled>-</button>
                        <span id="zoomLevelDisplay" class="w-full text-center font-mono text-sm">100%</span>
                        <button id="zoomInButton" class="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-bold text-lg disabled:opacity-50" disabled>+</button>
                    </div>
                    <button id="zoomResetButton" class="w-full py-2 px-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm font-semibold rounded-lg shadow transition-colors disabled:opacity-50" disabled>Reset Zoom</button>
                </div>

                
                <div class="space-y-2">
                    <button id="undoButton" class="w-full py-2 px-4 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg shadow transition-colors disabled:opacity-50" disabled>Undo Last Dot (Ctrl+Z)</button>
                    <button id="clearButton" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow transition-colors disabled:opacity-50" disabled>Clear All (This Image)</button>
                    <button id="toggleImageButton" class="w-full py-2 px-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow transition-colors disabled:opacity-50" disabled>Toggle Image</button>
                    <!-- NEW Toggle Numbers Button -->
                    <button id="toggleNumbersButton" class="w-full py-2 px-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow transition-colors disabled:opacity-50" disabled>Hide Numbers</button>
                </div>

                
                <div class="mt-6 border-t border-gray-300 dark:border-gray-600 pt-4">
                    <button id="downloadButton" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition-colors disabled:opacity-50" disabled>
                        Download as PNG
                    </button>
                    <button id="downloadAllButton" class="w-full mt-2 py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition-colors disabled:opacity-50" disabled>
                        Download All as PNGs
                    </button>
                </div>

            </aside>

            
            <div class="w-full md:col-span-3">
                <div id="canvas-container" class="relative w-full h-[70vh] bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-auto flex items-center justify-center">
                    <canvas id="dotCanvas" class="d2d-canvas"></canvas>
                    <div id="eraser-preview" class="absolute rounded-full border-2 border-red-500 pointer-events-none hidden" style="mix-blend-mode: difference;"></div>
                    <div id="placeholder-text" class="absolute text-gray-400 dark:text-gray-500 text-center p-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <h3 class="text-xl font-semibold">Upload an image to start</h3>
                        <p class="text-sm">Your image will appear here. Then, select a tool and click on the image to place dots.</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    
    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="modalTitle" class="text-lg font-semibold mb-4">Confirm Action</h3>
            <p id="modalMessage" class="text-sm text-gray-700 dark:text-gray-300 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-3">
                <button id="modalCancel" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 font-semibold rounded-lg shadow transition-colors">
                    Cancel
                </button>
                <button id="modalConfirm" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow transition-colors">
                    Yes, Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Info Modal (for About/Contact) -->
    <div id="infoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 id="infoModalTitle" class="text-lg font-semibold"></h3>
                <button id="infoModalClose" class="text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="infoModalContent" class="text-sm text-gray-700 dark:text-gray-300 space-y-4 max-h-[60vh] overflow-y-auto">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <!-- NEW: Share Modal (Pro Version) -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Share This Tool</h3>
                <button id="shareModalClose" class="text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">Share this tool with your friends!</p>
            
            <!-- Social Share Buttons -->
            <div class="flex justify-center space-x-4 mb-6">
                <!-- X (Twitter) -->
                <button id="shareTwitterButton" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <svg class="w-6 h-6 text-[#1DA1F2]" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </button>
                <!-- Facebook -->
                <button id="shareFacebookButton" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <svg class="w-6 h-6 text-[#1877F2]" fill="currentColor" viewBox="0 0 24 24"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.772-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"/></svg>
                </button>
                <!-- WhatsApp -->
                <button id="shareWhatsappButton" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <svg class="w-6 h-6 text-[#25D366]" fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2.02c-5.52 0-9.99 4.47-9.99 9.99 0 1.77.46 3.45 1.26 4.96l-1.26 4.59 4.7-1.23c1.47.74 3.09 1.15 4.81 1.15h.01c5.52 0 9.99-4.47 9.99-9.99s-4.47-9.99-9.99-9.99zM12.04 20.1c-1.54 0-3.02-.38-4.34-1.07l-.31-.18-3.23.84.86-3.14-.2-.33c-.76-1.37-1.17-2.92-1.17-4.57 0-4.48 3.63-8.12 8.12-8.12 2.19 0 4.23.86 5.74 2.37 1.51 1.51 2.37 3.55 2.37 5.74-.01 4.49-3.64 8.12-8.11 8.12zm4.52-6.14c-.25-.12-1.47-.72-1.7-.8s-.39-.12-.56.12c-.17.25-.64.8-.79.96-.15.17-.29.19-.54.06-.25-.12-1.06-.39-2.02-1.24-.75-.66-1.25-1.48-1.4-1.73-.15-.25-.02-.38.11-.5.12-.11.25-.29.38-.43.12-.15.17-.25.25-.41.08-.17.04-.31-.02-.43s-.56-1.34-.76-1.84c-.2-.48-.41-.42-.56-.42h-.5c-.17 0-.43.06-.66.31-.22.25-.86.85-.86 2.07 0 1.22.88 2.4 1 2.56.12.17 1.76 2.68 4.27 3.78 1.76.77 2.12.91 2.8.85.83-.07 1.47-.6 1.67-1.18.21-.58.21-1.07.15-1.18-.07-.12-.24-.19-.49-.31z"/></svg>
                </button>
                <!-- LinkedIn -->
                <button id="shareLinkedinButton" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <svg class="w-6 h-6 text-[#0A66C2]" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                </button>
                <!-- Email -->
                <button id="shareEmailButton" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6zm-2 0l-8 5-8-5h16zm0 12H4V8l8 5 8-5v10z"/></svg>
                </button>
            </div>
            
            <!-- Copy Link Input -->
            <div class="flex space-x-2">
                <input type="text" readonly id="shareLinkInput" class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                <button id="copyLinkButton" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow transition-colors">Copy</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('dotCanvas');
            const ctx = canvas.getContext('2d');
            const imageLoader = document.getElementById('imageLoader');
            
            // Controls
            const toolRadios = document.querySelectorAll('input[name="tool"]');
            const imageSelector = document.getElementById('imageSelector');
            const dotSizeSlider = document.getElementById('dotSize');
            const lineWidthSlider = document.getElementById('lineWidth'); 
            const fontSizeSlider = document.getElementById('fontSize'); 
            const dotSizeValue = document.getElementById('dotSizeValue');
            const lineWidthValue = document.getElementById('lineWidthValue'); 
            const fontSizeValue = document.getElementById('fontSizeValue'); 
            const eraseDotsRadiusSlider = document.getElementById('eraseDotsRadius');
            const eraseDotsRadiusValue = document.getElementById('eraseDotsRadiusValue');
            const eraseImageRadiusSlider = document.getElementById('eraseImageRadius');
            const eraseImageRadiusValue = document.getElementById('eraseImageRadiusValue');
            const dotColorPicker = document.getElementById('dotColorPicker');
            const lineColorPicker = document.getElementById('lineColorPicker');
            const spacingSlider = document.getElementById('spacingSlider');
            const spacingValue = document.getElementById('spacingValue');
            
            // Buttons
            const undoButton = document.getElementById('undoButton');
            const clearButton = document.getElementById('clearButton');
            const toggleImageButton = document.getElementById('toggleImageButton');
            const toggleNumbersButton = document.getElementById('toggleNumbersButton'); // NEW
            const downloadButton = document.getElementById('downloadButton');
            const downloadAllButton = document.getElementById('downloadAllButton'); 
            
            // Zoom Controls
            const zoomInButton = document.getElementById('zoomInButton');
            const zoomOutButton = document.getElementById('zoomOutButton');
            const zoomResetButton = document.getElementById('zoomResetButton');
            const zoomLevelDisplay = document.getElementById('zoomLevelDisplay');

            // Canvas Container
            const canvasContainer = document.getElementById('canvas-container');
            const placeholderText = document.getElementById('placeholder-text');
            const eraserPreview = document.getElementById('eraser-preview');

            // Confirm Modal Elements
            const confirmModal = document.getElementById('confirmModal');
            const modalMessage = document.getElementById('modalMessage');
            const modalCancel = document.getElementById('modalCancel');
            const modalConfirm = document.getElementById('modalConfirm');
            const modalTitle = document.getElementById('modalTitle');

            // Info Modal Elements
            const infoModal = document.getElementById('infoModal');
            const infoModalTitle = document.getElementById('infoModalTitle');
            const infoModalContent = document.getElementById('infoModalContent');
            const infoModalClose = document.getElementById('infoModalClose');
            const aboutButton = document.getElementById('aboutButton');
            const contactButton = document.getElementById('contactButton');

            // Share Modal Elements
            const shareModal = document.getElementById('shareModal');
            const shareButton = document.getElementById('shareButton');
            const shareModalClose = document.getElementById('shareModalClose');
            const copyLinkButton = document.getElementById('copyLinkButton');
            const shareLinkInput = document.getElementById('shareLinkInput'); // Get input field
            const shareTwitterButton = document.getElementById('shareTwitterButton');
            const shareFacebookButton = document.getElementById('shareFacebookButton');
            const shareWhatsappButton = document.getElementById('shareWhatsappButton');
            const shareLinkedinButton = document.getElementById('shareLinkedinButton');
            const shareEmailButton = document.getElementById('shareEmailButton');


            // Dark Mode Toggle
            const darkModeToggle = document.getElementById('darkModeToggle');

            // State
            let allDots = []; 
            let originalBackgroundImages = []; 
            let currentBackgroundImages = []; 
            let activeImageIndex = -1; 

            let showImage = true;
            let showNumbers = true; // NEW
            let currentTool = 'add'; 
            let dotSize = parseInt(dotSizeSlider.value, 10);
            let lineWidth = parseInt(lineWidthSlider.value, 10);
            let fontSize = parseInt(fontSizeSlider.value, 10);
            let eraseDotsRadius = parseInt(eraseDotsRadiusSlider.value, 10);
            let eraseImageRadius = parseInt(eraseImageRadiusSlider.value, 10);
            let dotColor = dotColorPicker.value;
            let lineColor = lineColorPicker.value;
            let dotSpacing = parseInt(spacingSlider.value, 10);
            let isDrawing = false; 
            let isPanning = false;
            let lastPanX = 0;
            let lastPanY = 0;

            let zoomLevel = 1.0;
            const minZoom = 0.2;
            const maxZoom = 5.0;

            // --- Dark Mode Logic ---
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    darkModeToggle.checked = true;
                } else {
                    document.documentElement.classList.remove('dark');
                    darkModeToggle.checked = false;
                }
            }

            darkModeToggle.addEventListener('change', (e) => {
                const theme = e.target.checked ? 'dark' : 'light';
                localStorage.setItem('theme', theme);
                applyTheme(theme);
            });

            // Apply theme on load
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (systemPrefersDark) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
            // --- End Dark Mode Logic ---

            // --- Info Modal Logic ---
            const aboutContent = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-lg text-gray-800 dark:text-gray-100 mb-2">About This Tool</h4>
                        <p>Welcome to the Dot-to-Dot Creator! This professional tool is designed to make creating connect-the-dots puzzles from your images simple and intuitive. Whether you're a blogger looking for engaging content, an educator creating learning materials, or just someone looking for a fun creative outlet, this tool has you covered.</p>
                        <p class="mt-2">It's built with modern web technologies and optimized for easy embedding directly into your blog or website, providing a seamless experience for your visitors.</p>
                    </div>
                    
                    <div>
                        <h5 class="font-semibold text-gray-800 dark:text-gray-100 mb-2">Key Features:</h5>
                        <ul class="list-disc list-inside space-y-1">
                            <li><b>Multi-Image Support:</b> Effortlessly manage and edit multiple dot-to-dot puzzles in one session.</li>
                            <li><b>Comprehensive Tools:</b> Precisely add dots, erase image sections or just the dots, pan across large images with the hand tool, and instantly pick colors from your image using the eyedropper.</li>
                            <li><b>Precision & Control:</b> Fine-tune your work with zoom-to-cursor functionality, optional fixed dot spacing for uniform layouts, and individually adjustable erase radii.</li>
                            <li><b>Full Customization:</b> Tailor the appearance of your puzzle by adjusting dot size, connecting line width, number size, and colors for both dots and lines.</li>
                            <li><b>Clean Output Options:</b> Toggle the visibility of the background image and dot numbers to create different styles or answer keys.</li>
                            <li><b>Batch Export:</b> Download all your created puzzles as high-quality PNG images individually or all at once.</li>
                            <li><b>Keyboard Shortcuts:</b> Use Ctrl+Z (or Cmd+Z) for quick undo actions.</li>
                            <li><b>Dark Mode:</b> Switch between light and dark themes for comfortable viewing.</li>
                        </ul>
                    </div>

                    <div>
                        <h4 class="font-semibold text-lg text-gray-800 dark:text-gray-100 mt-6 mb-2">About the Developer</h4>
                        <p>This tool was developed by Khalid Fer, a passionate web developer dedicated to creating high-quality, user-friendly tools. Khalid focuses on building practical applications that enhance creativity and productivity on the web.</p>
                        <p class="mt-2">If you find this tool useful, consider checking out Khalid's <a href="https://khalidfer.com" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline">blog</a> or connecting via the social media links in the Contact section!</p>
                    </div>
                </div>
            `;
            
            const contactContent = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-lg text-gray-800 dark:text-gray-100 mb-2">Get in Touch</h4>
                        <p>For any questions, feedback, or inquiries, please feel free to reach out:</p>
                        <a href="mailto:dev.khalidfer@gmail.com" class="text-blue-600 dark:text-blue-400 hover:underline">dev.khalidfer@gmail.com</a>
                        <p class="mt-2">Or visit my blog:</p>
                        <a href="https://khalidfer.com" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline">khalidfer.com</a>
                    </div>
                    
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h5 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">Subscribe to my Channel</h5>
                        <!-- YouTube Subscribe Button -->
                        <div class="g-ytsubscribe" data-channelid="UCARajj-TJdBNT66CjbkZJdQ" data-layout="full" data-count="default"></div>
                    </div>

                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h5 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">Follow Me</h5>
                        <div class="flex flex-wrap gap-4">
                            <!-- X (Twitter) -->
                            <a href="https://x.com/KhalidFer" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-blue-600 dark:hover:text-blue-400" title="X (Twitter)">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                            </a>
                            <!-- Facebook -->
                            <a href="https://web.facebook.com/Khalidfer0/" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-blue-600 dark:hover:text-blue-400" title="Facebook">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.772-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"/></svg>
                            </a>
                            <!-- Instagram -->
                            <a href="https://www.instagram.com/khalidferchach" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-blue-600 dark:hover:text-blue-400" title="Instagram">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.172.053 1.905.24 2.583.497.67.25 1.21.58 1.74.98.54.41.87.95.98 1.74.26.68.45 1.41.5 2.58.06 1.27.07 1.65.07 4.85s-.01 3.58-.07 4.85c-.05 1.17-.24 1.9-.5 2.58-.25.67-.58 1.21-.98 1.74-.41.54-.95.87-1.74.98-.68.26-1.41.45-2.58.5-.1.06-1.65.07-4.85.07s-3.58-.01-4.85-.07c-1.17-.05-1.9-.24-2.58-.5-.67-.25-1.21-.58-1.74-.98-.54-.41-.87-.95-.98-1.74-.26-.68-.45-1.41-.5-2.58-.06-1.27-.07-1.65-.07-4.85s.01-3.58.07-4.85c.05-1.17.24-1.9.5-2.58.25-.67.58-1.21.98-1.74.41-.54.95-.87 1.74.98.68-.26 1.41-.45 2.58-.5C8.417 2.175 8.796 2.163 12 2.163zm0 1.802c-3.14 0-3.48.01-4.7.07-1.07.05-1.7.22-2.2.42-.5.18-1.01.45-1.48.9-.47.47-.73.99-.9 1.48-.2.5-.37 1.13-.42 2.2-.06 1.22-.07 1.56-.07 4.7s.01 3.48.07 4.7c.05 1.07.22 1.7.42 2.2.18.5.45 1.01.9 1.48.47.47.99.73 1.48.9.5.2 1.13.37 2.2.42 1.22.06 1.56.07 4.7.07 3.14 0 3.48-.01 4.7-.07 1.07-.05 1.7-.22 2.2-.42.5-.18 1.01-.45 1.48-.9.47-.47.73-.99.9-1.48.2-.5.37-1.13.42-2.2.06-1.22.07-1.56.07-4.7s-.01-3.48-.07-4.7c-.05-1.07-.22-1.7-.42-2.2-.18-.5-.45-1.01-.9-1.48-.47-.47-.99-.73-1.48-.9-.5-.2-1.13-.37-2.2-.42C15.48 3.975 15.14 3.965 12 3.965zM12 9.75a6.25 6.25 0 100 12.5 6.25 6.25 0 000-12.5zm0 10.5c-2.34 0-4.25-1.91-4.25-4.25S9.66 7.5 12 7.5s4.25 1.91 4.25 4.25-1.91 4.25-4.25 4.25zM18.88 7.002a1.44 1.44 0 100-2.88 1.44 1.44 0 000 2.88z"/></svg>
                            </a>
                            <!-- TikTok -->
                            <a href="https://www.tiktok.com/@khalidfer" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-blue-600 dark:hover:text-blue-400" title="TikTok">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-2.43.05-4.84-.6-6.6-2.31-2.24-2.14-3.3-5-3.06-7.78.2-2.12 1.13-4.1 2.6-5.71 1.14-1.24 2.6-2.16 4.19-2.65.66-.21 1.32-.4 1.98-.51 1.21-.21 2.44-.3 3.65-.21h.01zM12 4.88c-1.11.02-2.21.31-3.22.92-1.27.76-2.3 1.9-2.94 3.21-.11.23-.19.46-.26.71-.48 1.83.19 3.8.99 5.37.79 1.56 2.08 2.8 3.65 3.5.7.31 1.45.52 2.2.62 1.3.17 2.62.1 3.9-.12.16-.02.32-.05.48-.07.41-.06.82-.13 1.23-.23.95-.23 1.86-.6 2.69-1.14.9-.6 1.6-1.43 2.07-2.39.23-.46.4-.95.54-1.46.12-.41.21-.83.27-1.25.07-.46.1-1.01.07-1.55-.02-.38-.06-.76-.12-1.14-.13-1.05-.44-2.07-.94-3.02-.6-1.12-1.44-2.08-2.47-2.8-.95-.67-2.03-1.13-3.15-1.35-.42-.08-.85-.13-1.28-.16-.36-.02-.71-.04-1.07-.04z"/></svg>
                            </a>
                            <!-- Telegram -->
                            <a href="https://t.me/+HazrwuUe9EExNGQ0" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-blue-600 dark:hover:text-blue-400" title="Telegram">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0011.944 0zM17.062 7.472c-.173.753-.618 2.626-1.07 4.966-.44 2.278-.89 4.54-1.01 4.965-.116.42-.328.525-.525.53-.306.01-.525-.116-.753-.233-1.01-.525-1.59-1.01-2.58-1.59-.99-.58-1.74-.29-2.73.524-.753.618-1.16 1.103-1.74 1.59-.752.618-1.336.524-1.59.232-.306-.35-.618-1.39-.99-3.223-.525-2.522-1.01-4.84-1.07-5.188-.06-1.047.525-1.59 1.447-1.59h6.183c.92 0 1.335.29 1.22.93z"/></svg>
                            </a>
                        </div>
                    </div>
                </div>
            `;

            aboutButton.addEventListener('click', () => {
                infoModalTitle.textContent = "About This Tool";
                infoModalContent.innerHTML = aboutContent;
                infoModal.classList.remove('hidden');
                // Re-render YouTube button if it's in the modal
                if (window.gapi && window.gapi.ytsubscribe) {
                    window.gapi.ytsubscribe.go();
                }
            });

            contactButton.addEventListener('click', () => {
                infoModalTitle.textContent = "Contact & Socials";
                infoModalContent.innerHTML = contactContent;
                infoModal.classList.remove('hidden');
                // Re-render YouTube button if it's in the modal
                if (window.gapi && window.gapi.ytsubscribe) {
                    window.gapi.ytsubscribe.go();
                }
            });

            infoModalClose.addEventListener('click', () => {
                infoModal.classList.add('hidden');
            });

            infoModal.addEventListener('click', (e) => {
                if (e.target === infoModal) {
                    infoModal.classList.add('hidden');
                }
            });
            // --- End Info Modal Logic ---

            // --- Share Modal Logic ---
            const shareURL = 'https://khalidfer.com';
            const shareTitle = 'Check out this awesome Dot-to-Dot Creator Tool!';
            shareLinkInput.value = shareURL;

            shareButton.addEventListener('click', () => {
                shareModal.classList.remove('hidden');
            });
            shareModalClose.addEventListener('click', () => {
                shareModal.classList.add('hidden');
            });
            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    shareModal.classList.add('hidden');
                }
            });
            copyLinkButton.addEventListener('click', () => {
                const textToCopy = shareLinkInput.value;
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';  // Ensure it's not visible
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    copyLinkButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyLinkButton.textContent = 'Copy Link';
                    }, 1500);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(textArea);
            });

            shareTwitterButton.addEventListener('click', () => {
                const url = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareURL)}&text=${encodeURIComponent(shareTitle)}`;
                window.open(url, '_blank');
            });

            shareFacebookButton.addEventListener('click', () => {
                const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareURL)}`;
                window.open(url, '_blank');
            });

            shareWhatsappButton.addEventListener('click', () => {
                const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareTitle + ' ' + shareURL)}`;
                window.open(url, '_blank');
            });

            shareLinkedinButton.addEventListener('click', () => {
                const url = `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(shareURL)}&title=${encodeURIComponent(shareTitle)}`;
                window.open(url, '_blank');
            });

            shareEmailButton.addEventListener('click', () => {
                const url = `mailto:?subject=${encodeURIComponent(shareTitle)}&body=${encodeURIComponent('Check it out: ' + shareURL)}`;
                window.location.href = url;
            });
            // --- End Share Modal Logic ---


            // --- Helper Functions ---
            function getMousePos(evt) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return {
                    x: (evt.clientX - rect.left) * scaleX,
                    y: (evt.clientY - rect.top) * scaleY
                };
            }

            function switchToImage(index) {
                if (index < 0 || index >= originalBackgroundImages.length) {
                    activeImageIndex = -1;
                    imageSelector.value = '';
                    canvas.width = 0; 
                    canvas.height = 0;
                    placeholderText.classList.remove('hidden');
                    disableControls(); 
                    draw(); 
                    return;
                }

                activeImageIndex = index;
                imageSelector.value = index;
                const activeImage = originalBackgroundImages[activeImageIndex];
                canvas.width = activeImage.width;
                canvas.height = activeImage.height;
                zoomLevel = 1.0;
                updateZoom();
                enableControls(); 
                draw();
            }

            function draw() {
                if (activeImageIndex === -1) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height); 
                    return;
                }

                const activeBg = currentBackgroundImages[activeImageIndex];
                const activeDots = allDots[activeImageIndex];
                if (!activeBg) return; 

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (showImage && activeBg) {
                    ctx.drawImage(activeBg, 0, 0);
                }

                if (lineWidth > 0 && activeDots.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(activeDots[0].x, activeDots[0].y);
                    for (let i = 1; i < activeDots.length; i++) {
                        ctx.lineTo(activeDots[i].x, activeDots[i].y);
                    }
                    ctx.strokeStyle = lineColor;
                    ctx.lineWidth = lineWidth;
                    ctx.stroke();
                }

                // NEW: Check showNumbers state
                if (showNumbers) {
                    ctx.font = `${fontSize}px Arial`;
                    ctx.textBaseline = 'middle';
                    activeDots.forEach(dot => {
                        // Draw dot
                        ctx.beginPath();
                        ctx.arc(dot.x, dot.y, dotSize, 0, 2 * Math.PI);
                        ctx.fillStyle = '#FFFFFF'; 
                        ctx.fill();
                        ctx.strokeStyle = dotColor; 
                        ctx.lineWidth = 1;
                        ctx.stroke();

                        // Draw number
                        ctx.fillStyle = dotColor; 
                        ctx.textAlign = 'right'; 
                        ctx.fillText(dot.number, dot.x - dotSize - 5, dot.y);
                    });
                } else {
                    // Still draw dots, just no numbers
                    activeDots.forEach(dot => {
                        ctx.beginPath();
                        ctx.arc(dot.x, dot.y, dotSize, 0, 2 * Math.PI);
                        ctx.fillStyle = '#FFFFFF'; 
                        ctx.fill();
                        ctx.strokeStyle = dotColor; 
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    });
                }
            }

            function updateZoom() {
                if (activeImageIndex === -1 || !originalBackgroundImages[activeImageIndex]) {
                    zoomLevel = 1.0;
                    zoomLevelDisplay.textContent = '100%';
                    canvas.style.width = 'auto';
                    canvas.style.height = 'auto';
                    canvas.style.setProperty('--canvas-width', 'auto');
                    canvas.style.setProperty('--canvas-height', 'auto');
                    return;
                }

                const activeImg = originalBackgroundImages[activeImageIndex];
                zoomLevel = Math.max(minZoom, Math.min(maxZoom, zoomLevel));
                zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
                const displayWidth = activeImg.width * zoomLevel;
                const displayHeight = activeImg.height * zoomLevel;
                canvas.style.width = `${displayWidth}px`;
                canvas.style.height = `${displayHeight}px`;
                canvas.style.setProperty('--canvas-width', `${displayWidth}px`);
                canvas.style.setProperty('--canvas-height', `${displayHeight}px`);
                zoomInButton.disabled = zoomLevel >= maxZoom;
                zoomOutButton.disabled = zoomLevel <= minZoom;
                zoomResetButton.disabled = zoomLevel === 1.0;
            }

            function enableControls() {
                placeholderText.classList.add('hidden');
                toolRadios.forEach(radio => radio.disabled = false);
                toggleImageButton.disabled = false;
                toggleNumbersButton.disabled = false; // NEW
                downloadButton.disabled = false;
                downloadAllButton.disabled = originalBackgroundImages.length === 0; 
                zoomInButton.disabled = false;
                zoomOutButton.disabled = false;
                zoomResetButton.disabled = false;
                imageSelector.disabled = originalBackgroundImages.length <= 1;
                updateButtonStates();
                updateZoom(); 
            }

            function disableControls() {
                toolRadios.forEach(radio => radio.disabled = true);
                undoButton.disabled = true;
                clearButton.disabled = true;
                toggleImageButton.disabled = true;
                toggleNumbersButton.disabled = true; // NEW
                downloadButton.disabled = true;
                downloadAllButton.disabled = true; 
                zoomInButton.disabled = true;
                zoomOutButton.disabled = true;
                zoomResetButton.disabled = true;
                imageSelector.disabled = true;
                imageSelector.innerHTML = '<option value="">Upload images first</option>';
            }

            function updateButtonStates() {
                if (activeImageIndex === -1) {
                    undoButton.disabled = true;
                    clearButton.disabled = true;
                    return;
                }
                const activeDots = allDots[activeImageIndex];
                undoButton.disabled = activeDots.length === 0;
                clearButton.disabled = activeDots.length === 0;
            }

            function renumberDots() {
                if (activeImageIndex === -1) return;
                const activeDots = allDots[activeImageIndex];
                activeDots.forEach((dot, index) => {
                    dot.number = index + 1;
                });
            }

            function eraseDotsAtPosition(e) {
                if (activeImageIndex === -1) return;
                const activeDots = allDots[activeImageIndex];
                const pos = getMousePos(e);
                let dotsRemoved = false;
                for (let i = activeDots.length - 1; i >= 0; i--) {
                    const dot = activeDots[i];
                    const distance = Math.sqrt(Math.pow(pos.x - dot.x, 2) + Math.pow(pos.y - dot.y, 2));
                    if (distance < eraseDotsRadius) {
                        activeDots.splice(i, 1);
                        dotsRemoved = true;
                    }
                }
                if (dotsRemoved) {
                    renumberDots();
                    updateButtonStates();
                }
            }

            function eraseCanvasContentAtPosition(e) {
                if (activeImageIndex === -1 || !currentBackgroundImages[activeImageIndex]) return;
                const activeBg = currentBackgroundImages[activeImageIndex];
                const pos = getMousePos(e);
                const tempCtx = activeBg.getContext('2d');
                tempCtx.save();
                tempCtx.beginPath();
                tempCtx.arc(pos.x, pos.y, eraseImageRadius, 0, 2 * Math.PI);
                tempCtx.clip();
                tempCtx.clearRect(0, 0, activeBg.width, activeBg.height);
                tempCtx.restore();
            }

            // --- Eyedropper Logic ---
            function componentToHex(c) {
              var hex = c.toString(16);
              return hex.length == 1 ? "0" + hex : hex;
            }
            function rgbToHex(r, g, b) {
              return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
            }
            function pickColor(e) {
                if (activeImageIndex === -1) return;
                const pos = getMousePos(e);
                // Get pixel data from the *displayed* canvas context
                const p = ctx.getImageData(pos.x, pos.y, 1, 1).data;
                const hex = rgbToHex(p[0], p[1], p[2]);
                
                // Set the color picker and state
                lineColorPicker.value = hex;
                lineColor = hex;
                
                // Switch back to 'add' tool automatically
                document.getElementById('tool-add').checked = true;
                currentTool = 'add';
                canvas.style.cursor = 'crosshair';
                canvasContainer.classList.remove('eyedropper-cursor');
                eraserPreview.classList.add('hidden');
            }
            // --- End Eyedropper Logic ---


            // --- Event Listeners ---
            imageLoader.addEventListener('change', (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) {
                    disableControls();
                    return;
                }
                originalBackgroundImages = new Array(files.length);
                currentBackgroundImages = new Array(files.length);
                allDots = new Array(files.length).fill(null).map(() => []); 
                imageSelector.innerHTML = ''; 
                placeholderText.classList.remove('hidden'); 
                let filesToLoad = files.length;
                let loadedCount = 0;
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const image = new Image();
                        image.onload = () => {
                            const tempCanvas = document.createElement('canvas');
                            tempCanvas.width = image.width;
                            tempCanvas.height = image.height;
                            const tempCtx = tempCanvas.getContext('2d');
                            tempCtx.drawImage(image, 0, 0);
                            originalBackgroundImages[index] = image;
                            currentBackgroundImages[index] = tempCanvas;
                            imageSelector.add(new Option(file.name, index));
                            loadedCount++;
                            if (loadedCount === filesToLoad) {
                                enableControls();
                                switchToImage(0); 
                            }
                        }
                        image.onerror = () => {
                            console.error(`Failed to load image: ${file.name}`);
                            loadedCount++;
                            if (loadedCount === filesToLoad) {
                                const firstLoadedIndex = originalBackgroundImages.findIndex(img => img);
                                if (firstLoadedIndex !== -1) {
                                    enableControls();
                                    switchToImage(firstLoadedIndex);
                                } else {
                                    disableControls(); 
                                }
                            }
                        }
                        image.src = event.target.result;
                    }
                    reader.onerror = () => {
                         console.error(`Failed to read file: ${file.name}`);
                         loadedCount++; 
                         if (loadedCount === filesToLoad) {
                             const firstLoadedIndex = originalBackgroundImages.findIndex(img => img);
                             if (firstLoadedIndex !== -1) {
                                 enableControls();
                                 switchToImage(firstLoadedIndex);
                             } else {
                                 disableControls();
                             }
                         }
                    }
                    reader.readAsDataURL(file);
                });
            });

            imageSelector.addEventListener('change', (e) => {
                const newIndex = parseInt(e.target.value, 10);
                if (!isNaN(newIndex)) {
                    switchToImage(newIndex);
                }
            });

            toolRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentTool = e.target.value;
                    canvasContainer.classList.remove('pan-cursor', 'panning-cursor', 'eyedropper-cursor');
                    canvas.classList.remove('eraser-cursor');
                    canvas.style.cursor = 'default'; // Reset
                    
                    if (currentTool.startsWith('erase')) {
                        canvas.classList.add('eraser-cursor');
                        eraserPreview.classList.remove('hidden');
                    } else if (currentTool === 'pan') {
                        canvasContainer.classList.add('pan-cursor');
                        eraserPreview.classList.add('hidden');
                    } else if (currentTool === 'eyedropper') {
                        canvasContainer.classList.add('eyedropper-cursor');
                        canvas.style.cursor = 'crosshair';
                        eraserPreview.classList.add('hidden');
                    } else {
                        // 'add' tool
                        canvas.style.cursor = 'crosshair';
                        eraserPreview.classList.add('hidden');
                    }
                });
            });

            canvas.addEventListener('click', (e) => {
                if (activeImageIndex === -1) return;

                if (currentTool === 'add') {
                    const pos = getMousePos(e);
                    const activeDots = allDots[activeImageIndex];
                    let newX = pos.x;
                    let newY = pos.y;
                    if (dotSpacing > 0 && activeDots.length > 0) {
                        const lastDot = activeDots[activeDots.length - 1];
                        const dx = pos.x - lastDot.x;
                        const dy = pos.y - lastDot.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance > 0) { 
                            const normX = dx / distance;
                            const normY = dy / distance;
                            newX = lastDot.x + normX * dotSpacing;
                            newY = lastDot.y + normY * dotSpacing;
                        } else {
                            return; 
                        }
                    }
                    activeDots.push({ x: newX, y: newY, number: activeDots.length + 1 });
                    updateButtonStates();
                    draw();
                } else if (currentTool === 'eyedropper') {
                    pickColor(e);
                }
            });

            canvas.addEventListener('mousedown', (e) => {
                if (activeImageIndex === -1) return;
                if (currentTool.startsWith('erase')) {
                    isDrawing = true; 
                    if (currentTool === 'erase-dots') {
                        eraseDotsAtPosition(e);
                    } else if (currentTool === 'erase-image') {
                        eraseCanvasContentAtPosition(e);
                    }
                    draw();
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (currentTool.startsWith('erase') && activeImageIndex !== -1) {
                    const rect = canvasContainer.getBoundingClientRect(); 
                    const previewLeft = e.clientX - rect.left + canvasContainer.scrollLeft;
                    const previewTop = e.clientY - rect.top + canvasContainer.scrollTop;
                    let currentEraserRadius = 0;
                    if (currentTool === 'erase-dots') {
                        currentEraserRadius = eraseDotsRadius;
                    } else if (currentTool === 'erase-image') {
                        currentEraserRadius = eraseImageRadius;
                    }
                    eraserPreview.style.width = `${currentEraserRadius * 2}px`;
                    eraserPreview.style.height = `${currentEraserRadius * 2}px`;
                    eraserPreview.style.left = `${previewLeft - currentEraserRadius}px`;
                    eraserPreview.style.top = `${previewTop - currentEraserRadius}px`;
                }
                if (isDrawing && currentTool.startsWith('erase')) {
                    if (currentTool === 'erase-dots') {
                        eraseDotsAtPosition(e);
                    } else if (currentTool === 'erase-image') {
                        eraseCanvasContentAtPosition(e);
                    }
                    draw(); 
                }
            });

            canvas.addEventListener('mouseleave', () => {
                if (currentTool.startsWith('erase')) {
                    eraserPreview.classList.add('hidden');
                }
                isDrawing = false; 
            });

            canvas.addEventListener('mouseenter', (e) => {
                if (currentTool.startsWith('erase') && activeImageIndex !== -1) {
                    eraserPreview.classList.remove('hidden');
                }
            });

            canvasContainer.addEventListener('mousedown', (e) => {
                if (currentTool === 'pan') {
                    e.preventDefault();
                    isPanning = true;
                    lastPanX = e.clientX;
                    lastPanY = e.clientY;
                    canvasContainer.classList.remove('pan-cursor');
                    canvasContainer.classList.add('panning-cursor');
                }
            });

            canvasContainer.addEventListener('mouseup', () => {
                if (isPanning) {
                    isPanning = false;
                    canvasContainer.classList.remove('panning-cursor');
                    canvasContainer.classList.add('pan-cursor');
                }
            });

            canvasContainer.addEventListener('mouseleave', () => {
                if (isPanning) {
                    isPanning = false;
                    canvasContainer.classList.remove('panning-cursor');
                    canvasContainer.classList.add('pan-cursor');
                }
            });
            
            canvasContainer.addEventListener('mousemove', (e) => {
                if (isPanning) {
                    e.preventDefault();
                    const dx = e.clientX - lastPanX;
                    const dy = e.clientY - lastPanY;
                    canvasContainer.scrollLeft -= dx;
                    canvasContainer.scrollTop -= dy;
                    lastPanX = e.clientX;
                    lastPanY = e.clientY;
                }
            });

            zoomInButton.addEventListener('click', () => {
                if (activeImageIndex === -1) return;
                const rect = canvasContainer.getBoundingClientRect();
                const mouseX = rect.width / 2;
                const mouseY = rect.height / 2;
                zoomAtPoint(mouseX, mouseY, 1.25); 
            });

            zoomOutButton.addEventListener('click', () => {
                if (activeImageIndex === -1) return;
                const rect = canvasContainer.getBoundingClientRect();
                const mouseX = rect.width / 2;
                const mouseY = rect.height / 2;
                zoomAtPoint(mouseX, mouseY, 0.8); 
            });

            zoomResetButton.addEventListener('click', () => {
                if (activeImageIndex === -1) return; 
                zoomLevel = 1.0;
                updateZoom();
                canvasContainer.scrollLeft = 0;
                canvasContainer.scrollTop = 0;
            });

            function zoomAtPoint(mouseX, mouseY, zoomFactor) {
                const oldScrollLeft = canvasContainer.scrollLeft;
                const oldScrollTop = canvasContainer.scrollTop;
                const oldZoom = zoomLevel;
                let newZoom = oldZoom * zoomFactor;
                newZoom = Math.max(minZoom, Math.min(maxZoom, newZoom)); 
                if (newZoom === oldZoom) return; 
                const imageX = (oldScrollLeft + mouseX) / oldZoom;
                const imageY = (oldScrollTop + mouseY) / oldZoom;
                zoomLevel = newZoom;
                updateZoom(); 
                const newScaledX = imageX * newZoom;
                const newScaledY = imageY * newZoom;
                canvasContainer.scrollLeft = newScaledX - mouseX;
                canvasContainer.scrollTop = newScaledY - mouseY;
            }

            canvasContainer.addEventListener('wheel', (e) => {
                if (activeImageIndex === -1) return;
                e.preventDefault(); 
                const rect = canvasContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left; 
                const mouseY = e.clientY - rect.top;
                const zoomFactor = e.deltaY < 0 ? 1.1 : 1 / 1.1; 
                zoomAtPoint(mouseX, mouseY, zoomFactor);
            }, { passive: false });


            dotSizeSlider.addEventListener('input', (e) => {
                dotSize = parseInt(e.target.value, 10);
                dotSizeValue.textContent = dotSize;
                draw();
            });
            lineWidthSlider.addEventListener('input', (e) => {
                lineWidth = parseInt(e.target.value, 10);
                lineWidthValue.textContent = lineWidth;
                draw();
            });
            fontSizeSlider.addEventListener('input', (e) => {
                fontSize = parseInt(e.target.value, 10);
                fontSizeValue.textContent = fontSize;
                draw();
            });
            eraseDotsRadiusSlider.addEventListener('input', (e) => {
                eraseDotsRadius = parseInt(e.target.value, 10);
                eraseDotsRadiusValue.textContent = eraseDotsRadius;
                if (currentTool === 'erase-dots') {
                    eraserPreview.style.width = `${eraseDotsRadius * 2}px`;
                    eraserPreview.style.height = `${eraseDotsRadius * 2}px`;
                }
            });
            eraseImageRadiusSlider.addEventListener('input', (e) => {
                eraseImageRadius = parseInt(e.target.value, 10);
                eraseImageRadiusValue.textContent = eraseImageRadius;
                if (currentTool === 'erase-image') {
                    eraserPreview.style.width = `${eraseImageRadius * 2}px`;
                    eraserPreview.style.height = `${eraseImageRadius * 2}px`;
                }
            });
            spacingSlider.addEventListener('input', (e) => {
                dotSpacing = parseInt(e.target.value, 10);
                spacingValue.textContent = dotSpacing;
            });
            dotColorPicker.addEventListener('input', (e) => {
                dotColor = e.target.value;
                draw();
            });
            lineColorPicker.addEventListener('input', (e) => {
                lineColor = e.target.value;
                draw();
            });

            undoButton.addEventListener('click', () => {
                if (activeImageIndex === -1) return;
                const activeDots = allDots[activeImageIndex];
                if (activeDots.length > 0) {
                    activeDots.pop();
                    updateButtonStates();
                    draw();
                }
            });

            clearButton.addEventListener('click', () => {
                if (activeImageIndex === -1) return;
                modalTitle.textContent = 'Clear All Dots & Edits';
                modalMessage.textContent = 'Are you sure you want to clear all dots and image erasures for the CURRENT image? This action cannot be undone.';
                modalConfirm.textContent = 'Yes, Clear All';
                confirmModal.classList.remove('hidden');
            });

            modalCancel.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
            });

            modalConfirm.addEventListener('click', () => {
                if (activeImageIndex === -1) return;
                allDots[activeImageIndex] = [];
                const originalImg = originalBackgroundImages[activeImageIndex];
                const activeBgCanvas = currentBackgroundImages[activeImageIndex];
                if (originalImg && activeBgCanvas) {
                    const tempCtx = activeBgCanvas.getContext('2d');
                    tempCtx.clearRect(0, 0, activeBgCanvas.width, activeBgCanvas.height);
                    tempCtx.drawImage(originalImg, 0, 0);
                }
                zoomLevel = 1.0;
                updateZoom();
                updateButtonStates();
                draw();
                confirmModal.classList.add('hidden');
            });
            
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault(); 
                    if (!undoButton.disabled) {
                        undoButton.click();
                    }
                }
            });

            toggleImageButton.addEventListener('click', () => {
                if (activeImageIndex === -1) return;
                showImage = !showImage;
                toggleImageButton.textContent = showImage ? 'Hide Image' : 'Show Image';
                draw();
            });

            // Toggle Numbers Button Listener
            toggleNumbersButton.addEventListener('click', () => {
                if (activeImageIndex === -1) return;
                showNumbers = !showNumbers;
                toggleNumbersButton.textContent = showNumbers ? 'Hide Numbers' : 'Show Numbers';
                draw();
            });

            // Re-usable download logic
            function createDownloadCanvas(index, currentSettings) {
                const activeBg = currentBackgroundImages[index];
                const activeDots = allDots[index];
                const originalImg = originalBackgroundImages[index];
                if (!originalImg) return null;

                const { lineW, dotS, fontS, dotC, lineC, showNum } = currentSettings;

                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = originalImg.width;
                tempCanvas.height = originalImg.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.fillStyle = '#FFFFFF';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                if (showImage && activeBg) {
                    tempCtx.drawImage(activeBg, 0, 0);
                }
                if (lineW > 0 && activeDots.length > 1) {
                    tempCtx.beginPath();
                    tempCtx.moveTo(activeDots[0].x, activeDots[0].y);
                    for (let i = 1; i < activeDots.length; i++) {
                        tempCtx.lineTo(activeDots[i].x, activeDots[i].y);
                    }
                    tempCtx.strokeStyle = lineC;
                    tempCtx.lineWidth = lineW; 
                    tempCtx.stroke();
                }

                if (showNum) {
                    tempCtx.font = `${fontS}px Arial`;
                    tempCtx.textBaseline = 'middle';
                    activeDots.forEach(dot => {
                        tempCtx.beginPath();
                        tempCtx.arc(dot.x, dot.y, dotS, 0, 2 * Math.PI);
                        tempCtx.fillStyle = '#FFFFFF';
                        tempCtx.fill();
                        tempCtx.strokeStyle = dotC;
                        tempCtx.lineWidth = 1;
                        tempCtx.stroke();
                        tempCtx.fillStyle = dotC;
                        tempCtx.textAlign = 'right'; 
                        tempCtx.fillText(dot.number, dot.x - dotS - 5, dot.y); 
                    });
                } else {
                    activeDots.forEach(dot => {
                        tempCtx.beginPath();
                        tempCtx.arc(dot.x, dot.y, dotS, 0, 2 * Math.PI);
                        tempCtx.fillStyle = '#FFFFFF';
                        tempCtx.fill();
                        tempCtx.strokeStyle = dotC;
                        tempCtx.lineWidth = 1;
                        tempCtx.stroke();
                    });
                }
                return tempCanvas;
            }

            downloadButton.addEventListener('click', () => {
                if (activeImageIndex === -1) return;
                
                // Get all current settings
                const currentSettings = {
                    lineW: parseInt(lineWidthSlider.value, 10),
                    dotS: parseInt(dotSizeSlider.value, 10),
                    fontS: parseInt(fontSizeSlider.value, 10),
                    dotC: dotColorPicker.value,
                    lineC: lineColorPicker.value,
                    showNum: showNumbers
                };
                
                const tempCanvas = createDownloadCanvas(activeImageIndex, currentSettings);
                if (!tempCanvas) return;
                
                const link = document.createElement('a');
                const fileName = imageSelector.options[activeImageIndex] ? imageSelector.options[activeImageIndex].text : `image-${activeImageIndex + 1}`;
                const baseName = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
                link.download = `dot-to-dot-${baseName}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            });
            
            downloadAllButton.addEventListener('click', () => {
                if (originalBackgroundImages.length === 0) return;

                // Get all current settings once
                const currentSettings = {
                    lineW: parseInt(lineWidthSlider.value, 10),
                    dotS: parseInt(dotSizeSlider.value, 10),
                    fontS: parseInt(fontSizeSlider.value, 10),
                    dotC: dotColorPicker.value,
                    lineC: lineColorPicker.value,
                    showNum: showNumbers
                };

                for (let i = 0; i < originalBackgroundImages.length; i++) {
                    const tempCanvas = createDownloadCanvas(i, currentSettings);
                    if (!tempCanvas) continue;

                    const link = document.createElement('a');
                    const fileName = imageSelector.options[i] ? imageSelector.options[i].text : `image-${i + 1}`;
                    const baseName = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
                    link.download = `dot-to-dot-${baseName}.png`;
                    link.href = tempCanvas.toDataURL('image/png');
                    link.click();
                }
            });

            // Initial state setup
            disableControls();
        });
    </script>
</body>
</html>

